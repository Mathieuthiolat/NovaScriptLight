<html>
<head>
  <title>NovaRally Helper - Dashboard</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="./assets/css/style.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src='./assets/js/waxjs.js'></script>
</head>


<body>
  <div id="root">
    <div>
      <div class="navbar">
        <a href="./">Dashboard</a>
        <a href="./bulk-race">BulkRace</a>
      </div> 
    </div>
    <div class="sub-navbar">
      <div id="login-btn">
        <button id="login" onclick=login()>WAX Login</button>
      </div>
      <div id="login-info" class="hidden">
        <span>Account : </span>
        <span id="account-name" style="min-width: 50px;display: inline-block;font-weight: bold;"></span>
        <span class="disconectIcon" style="color: red;" onclick=disconect()>&#10008;</span>
      </div>
      
      <!--
      <span class="spliter"></span>
      <span>Current Fuel : </span>
      <span id="current-boost" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakgas" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakoil" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakpow" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakven" style="min-width: 50px;display: inline-block;">NaN</span>
      <span class="spliter"></span>
      <span>Unclaimed fuel : </span>
      <span id="unclaimed-fuel" style="min-width: 50px;display: inline-block;">NaN</span>
      <span class="spliter"></span>
      <span>Other Token : </span>
      -->


    </div>
    <div>
      <div style="text-align: center;margin: 15px 0px;">
        <input id="user" name="user" type="text" placeholder="user name" style="color: black;"/>
        <input id="nbRace" name="nbRace" type="number" placeholder="10" style="color: black;width: 80px;"/>
        <button id="fetch_user" onclick="fetchData()">Fetch user data</button>
      </div>
      <table class="table" id="resultDisplay">
        <thead>
          <tr>
            <th scope="col" >Date</th>
            <th scope="col" >Cars</th>
            <th scope="col" >Driver</th>
            <th scope="col" >Copilote</th>
            <th scope="col" >League</th>
            <th scope="col" >Gear</th>
            <th scope="col" >Position</th>
            <th scope="col" >Reward</th>
            <th scope="col" >Gain/lost</th>
          </tr>  
        </thead>
      </table>  
      <div id="loader" class="hidden">
        <img src="./assets/medias/step-loader.gif" alt="loader">
      </div>
    </div>
  </div>

</body>
<script type="text/javascript" src="./assets/js/utils.js"></script>
<script type="text/javascript" src='./assets/js/scriptDashboard.js'></script>
<script type="module" src=" /node/script-table"></script>
<script type="text/javascript">
  var arr = {}; 
  var myRaces = []
  var user = "";

  $(document).ready(() => {
    if(checkLogin() == true){
      $("#user")[0].placeholder = sessionStorage.getItem("userAccount")
    }
  });

  function fetchData(){
    if(!checkLogin()){
      return;
    }
    resetTable()

    $("#loader")[0].classList.remove("hidden");

    user = ($('#user').val() != "")? $('#user').val() : sessionStorage.getItem('userAccount');

    asyncCall().then((response)=>{
      createMyRaces(response.data);
    });
  }

  async function asyncCall(){    
    var nbRaces = ($('#nbRace').val() != "")? $('#nbRace').val() : 10;
    

    try {
        result = await $.ajax({
          url: '/getRaceList/'+user+'/'+nbRaces
        });

        return result;
    } catch (error) {
        console.error(error);
    }
  }

  async function createMyRaces(array){    
    return new Promise(async resolve => {
      raceArray = [];

      for(i=0;i<array.length; i++){
      //array.forEach(async race=>{
        var tmpRace = {date : "",vehicle : {},driver : {},copilote : {},league : "",gear : "",position : "",reward : "",gainLost : {}};

        tmpRace.date =  new Date(array[i].startedDate).toLocaleString();

        var vehicle = await later(array[i].vehicleAssetId);
        tmpRace.vehicle = vehicle;
        var driver = await later(array[i].driver1AssetId);
        tmpRace.driver = driver;
        var copilote = await later(array[i].driver2AssetId);
        tmpRace.copilote = copilote;

        tmpRace.league = array[i].league;
        tmpRace.gear = array[i].gearId;
        tmpRace.position =  array[i].position;

        var racesDetail = await getRaceDetail(array[i].race_id)
        var reward = "";
        racesDetail.prizes.forEach(async prize=>{
          if(prize.type == "TOKEN"){
            reward += "<img alt='Charm' src='https://play.novarally.io/assets/pic/CHARM.webp' width='26' height='26'><span>"+prize.charmTokenAmount+"</span>";
          }
          if(prize.type == "ASSET"){
            var prize_template = await getTemplateInfo(template_id => prize.templateId);

            reward += "<img src='https://atomichub-ipfs.com/ipfs/"+prize_template.immutable_data.img+"' style='width: 70px;' /><br><span>"+prize_template.name+"</span>" 
          }
        }) 
        tmpRace.reward = reward;
        raceArray.push(tmpRace);

      }
      sortDisplayRaceArray(raceArray)

      resolve('resolved');
    });
  }
  function sortDisplayRaceArray(races){

    $("#loader")[0].classList.add("hidden");

    races.forEach(element => {

      var date = $("<td></td>").html("<span>"+element.date+"</span>") ;        
      var vehicleHtml = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.vehicle.template.immutable_data.img+"' style='width: 50px;' /><br><span>"+element.vehicle.name+"</span>") ;        
      var driverHtml = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.driver.template.immutable_data.img+"' style='width: 50px;'/><br><span>"+element.driver.name+"</span>") ;        
      var copiloteHtml = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.copilote.template.immutable_data.img+"' style='width: 50px;'/><br><span>"+element.copilote.name+"</span>") ;        
      var leagueHtml = $("<td></td>").html("<span>"+element.league+"</span>") ;        
      var gearHtml = $("<td></td>").html("<span>"+element.gear+"</span>") ;        
      var positionHtml = $("<td></td>").html("<span>"+element.position+"</span>") ;        
      var rewardHtml = $("<td></td>").html("<div>"+element.reward+"</div>") ;        
      //var gainLostDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
      
      var row = $("<tr class='raceRow'></tr>").append(date,vehicleHtml,driverHtml,copiloteHtml,leagueHtml,gearHtml,positionHtml,rewardHtml);   
      $("#resultDisplay").append(row);

    });
  }

  async function getRaceDetail(id_race){
    return new Promise(async resolve => {

      var temp = await $.ajax({
        url: '/getRaceDetail/'+id_race
      });

      temp.participants.forEach(participant=>{
        if(participant.accountName == user){
          resolve(participant);
        }
      })      
    })
  }
</script>
</html>