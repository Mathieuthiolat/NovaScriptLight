<html>
<head>
  <title>NovaRally Helper - Dashboard</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="./assets/css/style.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src='./assets/js/waxjs.js'></script>
</head>


<body>
  <div id="root">
    <div>
      <div class="navbar">
        <a href="./">Dashboard</a>
        <a href="./bulk-race">BulkRace</a>
      </div> 
    </div>
    <div class="sub-navbar">
      <div id="login-btn">
        <button id="login" onclick=login()>WAX Login</button>
      </div>
      <div id="login-info" class="hidden">
        <span>Account : </span>
        <span id="account-name" style="min-width: 50px;display: inline-block;font-weight: bold;"></span>
        <span class="disconectIcon" style="color: red;" onclick=disconect()>&#10008;</span>
      </div>
      <span class="spliter"></span>
      <span>Current Fuel : </span>
      <span id="current-boost" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakgas" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakoil" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakpow" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakven" style="min-width: 50px;display: inline-block;">NaN</span>
      <span class="spliter"></span>
      <span>Unclaimed fuel : </span>
      <span id="unclaimed-fuel" style="min-width: 50px;display: inline-block;">NaN</span>
      <span class="spliter"></span>
      <span>Other Token : </span>
      


    </div>
    <div>
      <div style="text-align: center;margin: 15px 0px;">
        <input id="user" name="user" type="text" placeholder="user name" style="color: black;"/>
        <button id="fetch_user" onclick="fetchData()">Fetch user data</button>
      </div>
      <table class="table" id="resultDisplay">
        <thead>
          <tr>
            <th scope="col" >Cars</th>
            <th scope="col" >Driver</th>
            <th scope="col" >Copilote</th>
            <th scope="col" >League</th>
            <th scope="col" >Gear</th>
            <th scope="col" >Position</th>
            <th scope="col" >Reward</th>
            <th scope="col" >Gain/lost</th>
          </tr>  
        </thead>
      </table>  
      <div id="loader" class="hidden">
        <img src="./assets/medias/step-loader.gif" alt="loader">
      </div>
    </div>
  </div>

</body>
<script type="text/javascript" src="./assets/js/utils.js"></script>
<script type="text/javascript" src='./assets/js/scriptDashboard.js'></script>
<script type="module" src=" /node/script-table"></script>
<script type="text/javascript">
  var arr = {}; 
  var myRaces = []
  var user = "";

  $(document).ready(() => {
    if(checkLogin()){
      fetchData();
    }
  });

  function fetchData(){
    user = ($('#user').val() != "")? $('#user').val() : sessionStorage.getItem('userAccount');

    asyncCall().then((response)=>{
      createMyRaces(response.data);
    });
  }

  async function asyncCall(){    
    var nbRaces = $('#nbRace').val() ?? 20;
    console.log('DBG : race result ');

    try {
        result = await $.ajax({
          url: '/getRaceList/'+user+'/'+nbRaces
        });
        console.log("--- Start ---");
        console.log(result);
        console.log("--- End ---");

        return result;
    } catch (error) {
        console.error(error);
    }
  }

  async function createMyRaces(array){    
    return new Promise(async resolve => {
      array.forEach(async race=>{
        var vehicle = await later(race.vehicleAssetId);
        var driver = await later(race.driver1AssetId);
        var copilote = await later(race.driver2AssetId);
        var league = race.league;
        var gear = race.gearId;
        var position = race.position;
        var racesDetail = await getRaceDetail(race.race_id)
        console.log(racesDetail);
        var reward = "";

        racesDetail.prizes.forEach(async prize=>{
          if(prize.type == "TOKEN"){
            reward += "<img alt='Charm' src='https://play.novarally.io/assets/pic/CHARM.webp' width='26' height='26'><span>"+prize.charmTokenAmount+"</span>";
          }
          if(prize.type == "ASSET"){
            var prize_template = await getTemplateInfo(template_id => prize.templateId);

            reward += "<img src='https://atomichub-ipfs.com/ipfs/"+prize_template.immutable_data.img+"' style='width: 70px;' /><br><span>"+element.vehicle.name+"</span><br><span>"+element.vehicle.id+"<span>"
            reward += "<img src='https://atomichub-ipfs.com/ipfs/"++"' style='width: 100px;'>"
            
          }

        })   
        var reward = race.position;


      }) 
      resolve('resolved');
    });
  }

  async function getRaceDetail(id_race){
    return new Promise(async resolve => {

      var temp = await $.ajax({
        url: '/getRaceDetail/'+id_race
      });

      temp.participants.forEach(participant=>{
        if(participant.accountName == user){
          resolve(participant);
        }
      })      
    })
  }

  function sortDisplayRaceArray(races){

    races.forEach(element => {

      var vehicleDetail = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.vehicle.img+"' style='width: 100px;' /><br><span>"+element.vehicle.name+"</span><br><span>"+element.vehicle.id+"<span>") ;        
      var driverDetail = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.driver1.img+"' style='width: 100px;'/><br><span>"+element.driver1.name+"</span><br><span>"+element.driver1.id+"</span>") ;        
      var copiloteDetail = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.driver2.img+"' style='width: 100px;'/><br><span>"+element.driver2.name+"</span><br><span>"+element.driver2.id+"</span>") ;        
      var leagueDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
      var gearDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
      var positionDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
      var rewardDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
      var gainLostDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
      var row = $("<tr class='raceRow'></tr>").append(vehicleDetail,driverDetail,copiloteDetail,leagueDetail,statusDetail);   
      $("#resultDisplay").append(row);

    });
  }

</script>
</html>