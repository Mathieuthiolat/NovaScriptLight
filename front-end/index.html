<html>
<head>
  <title>Express HTML</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src='./assets/js/waxjs.js'></script>
</head>
<style>
  #resultDisplay {
    font-family: Arial, Helvetica, sans-serif;
    border-collapse: collapse;
    width: 100%;
  }
  
  #resultDisplay td, #resultDisplay th {
    border: 1px solid #ddd;
    padding: 8px;
  }
  
  #resultDisplay tr:nth-child(even){background-color: #f2f2f2;}
  
  #resultDisplay tr:hover {background-color: #ddd;}
  
  #resultDisplay th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #000000;
    color: white;
  }
  </style>
<body>
  <div style="margin:100px;">
    <nav class="navbar navbar-inverse navbar-static-top">
      <div class="container">
        <ul class="nav navbar-nav">
          <li id="account-info" class="active" style="margin-right: 50px;">
            <p style="display: block;color: #fff;">
              Account : <span id="account-name"></span>
            </p>
            <button id="login" onclick=login()>WAX Login</button>
          </li>

          <li class="active">
            <label style="color:#fff;">Choisir ca league</label>
            <select name="league" id="league-select">
              <option value="false">Tous</option>
              <option value="rookie">Rookie</option>
              <option value="intermediate">Intermediate</option>
              <option value="veteran">Veteran</option>
              <option value="master">Master</option>
            </select>
            <label style="color:#fff;">Choisir la place</label>
            <select name="place" id="place-select">
              <option value="false">Tous</option>
              <option value="1">1er</option>
              <option value="2">2eme</option>
              <option value="3">3eme</option>
              <option value="4">4eme</option>
            </select>
            <label style="color:#fff;">Choisir Ton gear</label>
            <select name="gear" id="gear-select">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
            <button onclick="asyncCall()">Get</button>
          </li>
          <li>
            <button onclick="setUpBulkRace()">Set up bulk Race</button>
          </li>
          <li>
            <button onclick="launchBulkRace(raceArray)">Launch bulk Race</button>
          </li>
        </ul>
      </div>
   </nav>
    <div class="jumbotron"  style="padding:40px;">
      <table id="resultDisplay">
        <tr>
          <th scope="col" >Cars</th>
          <th scope="col" >Driver</th>
          <th scope="col" >Copilote</th>
          <th scope="col" >League</th>
          <th scope="col" >Status</th>
        </tr>
      </table>  
      <div id="loader" style="display: none;">
        <img src="./assets/medias/step-loader.gif" alt="loader">
      </div>
      <hr>
      <div>
        <br>
        <code id="response">
          Transaction Response<br>
        </code>
        <code id="loginresponse">

        </code>
      </div>
   </div>
  </div>
</body>
<script type="text/javascript" src="./assets/js/utils.js"></script>
<script type="text/javascript" src='./assets/js/script.js'></script>
<script type="module" src=" /node/script-table"></script>
<script type="text/javascript">
  var arr = {}; 
  var myAssets = {}
  var raceArray = []
  
  $(document).ready(() => {
    login().then(()=> {
      //GET all passed race
      //asyncCall();
    })
  });


function setUpBulkRace(){
    //GET all assets 
    laterAssets().then((assetsList) => {
      myAssets = assetsList
      //Get assets that are being used and remove them
      getRunningAssets().then(()=>{
        //Create Array of bulk race from All assets availible
        randomRacesArray().then(()=>{
          logDebug("Array created")
          console.log(raceArray)
        })

      })
    })
}

async function laterAssets(){    
  let result;
  try {
      result = await $.ajax({
          url: 'getAssets/'+sessionStorage.getItem('userAccount')
      });

      return result.data;
  } catch (error) {
      console.error(error);
  }
}

async function laterRunningAssets(){    
  let result;
  try {
      result = await $.ajax({
          url: 'getAssetsRuning/'+sessionStorage.getItem('userAccount')
      });
      return result;
  } catch (error) {
      console.error(error);
  }
}

function getKeyByValue(object, value) {
  return Object.keys(object).find(key => object[key] === value);
}


async function getRunningAssets(){
  laterRunningAssets().then((assetsToRemove)=>{

    if(assetsToRemove+"" != ""){
      assetsToRemove.forEach(element => {
        //On check driver
        var vehicleArrayKey = getKeyByValue(myAssets.vehicles,element.vehicle_asset_id)
        var driver1ArrayKey = getKeyByValue(myAssets.drivers,element.driver1_asset_id)
        var driver2ArrayKey = getKeyByValue(myAssets.drivers,element.driver2_asset_id)

        if(vehicleArrayKey != undefined){
          myAssets.vehicles.splice(vehicleArrayKey,1)
        }
        if(driver1ArrayKey != undefined){
          myAssets.drivers.splice(driver1ArrayKey,1)
        }
        if(driver2ArrayKey != undefined){
          myAssets.drivers.splice(driver2ArrayKey,1)
        }
      });
    }
  })
}

async function randomRacesArray(){
  return new Promise(async resolve => {
    raceArray = [];
    resetTable()

    //Get driver + 2 random asset that are not the same name 
    //Get id + name + img + league 
    var nbVechicles = myAssets.vehicles.length;
    for(i=0;i<nbVechicles; i++){
      try {
        var tmpRace = {vehicle : {},driver1 : {},driver2 : {},league : {}};

        var vehicle = await later(myAssets.vehicles[i])
        tmpRace.vehicle.id = vehicle.asset_id;
        tmpRace.vehicle.name = vehicle.data.name;
        tmpRace.vehicle.league = vehicle.data.Quality;
        tmpRace.vehicle.img = vehicle.data.img;

        var driver1 = await getRandomDriver(myAssets.drivers);
        tmpRace.driver1.id = driver1.asset_id;
        tmpRace.driver1.name = driver1.data.name;
        tmpRace.driver1.league = driver1.data.Quality;
        tmpRace.driver1.img = driver1.data.img;
        
        var driver2 = await getRandomDriver(myAssets.drivers,driver1);
        logDebug("choisen " +driver2.data.name + " - "+driver2.asset_id)
        tmpRace.driver2.id = driver2.asset_id;
        tmpRace.driver2.name = driver2.data.name;
        tmpRace.driver2.league = driver2.data.Quality;
        tmpRace.driver2.img = driver2.data.img;

        if(tmpRace.driver1.league == tmpRace.driver2.league && tmpRace.driver2.league == tmpRace.vehicle.league){
          tmpRace.league = tmpRace.vehicle.league.toLowerCase();
        }
        else{
          tmpRace.league = "rookie";
        }

        raceArray.push(tmpRace)

      } catch (error) {
        logDebug("skiped one vehicle "+myAssets.vehicles[i]+" - "+error) 
      }
    }

    sortDisplayRaceArray(raceArray)
    resolve('resolved');
  });
}

function sortDisplayRaceArray(races){

  races.sort(function(a, b) {
    var x = a.league.toLowerCase(), y = b.league.toLowerCase();
    return x < y ? -1 : x > y ? 1 : 0;
  });

  races.forEach(element => {

    var vehicleDetail = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.vehicle.img+"' style='width: 100px;' /><br><span>"+element.vehicle.name+"</span><br><span>"+element.vehicle.id+"<span>") ;        
    var driverDetail = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.driver1.img+"' style='width: 100px;'/><br><span>"+element.driver1.name+"</span><br><span>"+element.driver1.id+"</span>") ;        
    var copiloteDetail = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+element.driver2.img+"' style='width: 100px;'/><br><span>"+element.driver2.name+"</span><br><span>"+element.driver2.id+"</span>") ;        
    var leagueDetail = $("<td></td>").html("<h3>"+element.league+"</h3>") ;        
    var statusDetail = $("<td></td>").html("<p>Pending</p>") ;        
    var row = $("<tr class='raceRow'></tr>").append(vehicleDetail,driverDetail,copiloteDetail,leagueDetail,statusDetail);   
    $("#resultDisplay").append(row);

  });
}

async function getRandomDriver(driverList,firstDriver = ""){
  var nbDriver = driverList.length
  var driverNumber = Math.floor(Math.random()*(nbDriver-1));
  var returnDriver;
  if(firstDriver != ""){
    //Previous driver name
     driver2 = await later(driverList[driverNumber])
     if(driver2.data.name != undefined && driver2.data.name !=  firstDriver.name){
        myAssets.drivers.splice(driverNumber,1)
        return driver2
  
      }else{
        logDebug("redo")
        getRandomDriver(driverList,firstDriver)
      } 
  }else{
    returnDriver = await later(driverList[driverNumber]);
    myAssets.drivers.splice(driverNumber,1)
    return returnDriver
  }
}


async function launchBulkRace(arrOfRace){
  //Get first row & first race in the array
  element = arrOfRace[0];

  try {
    await sign(element.driver1.id, element.driver2.id,element.vehicle.id,element.league.toLowerCase())    
    //Light up the row on display when the race is launched
    $('.raceRow')[0].style = "background:#12860173";
    $('.raceRow')[0].childNodes[4].innerHTML = "<h3>Launched</h3>";
    $('.raceRow')[0].classList.remove("raceRow")


  } catch (error) {
    logDebug("Cannot launch the race : "+element+"- "+error)
    //Light up the row on display when the race is launched
    $('.raceRow')[0].style = "background:red";
    $('.raceRow')[0].childNodes[4].innerHTML = "<h3>Failed</h3>";
    $('.raceRow')[0].classList.remove("raceRow")

  }
  //Remove first row of the raceArray
  logDebug("delete last row")
  arrOfRace.splice(0,1)

  //Relaunch if the array is not empty
  if(arrOfRace.length != 0){
    logDebug("Launching next race")
    setTimeout(() => {launchBulkRace(arrOfRace)}, 1000);
  }else{
    logDebug("Ended All races launched")
  }
}

</script>
</html>