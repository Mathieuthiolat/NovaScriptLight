<html>
<head>
  <title>NovaRally Helper - Dashboard</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="./assets/css/style.css">
  <script src='./assets/js/waxjs.js'></script>
</head>


<body>
  <div id="root">
    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a href="./"  class="active">Dashboard</a>
            </li>
            <li class="nav-item">
              <a href="./bulk-race">BulkRace</a>
            </li>
            <li class="nav-item">
              CHARM <span id="charmPrice">0,0</span>
            </li>
            <li class="nav-item">
              Boost <span id="boostPrice">0,0</span>
            </li>
            <li class="nav-item">
              SnakOil <span id="oilPrice">0,0</span>
            </li>
            <li class="nav-item">
              SnakGas <span id="gasPrice">0,0</span>
            </li>
            <li class="nav-item">
              SnakPow <span id="powPrice">0,0</span>
            </li>
            <li class="nav-item">
              SnakVen <span id="venPrice">0,0</span>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="sub-navbar">
      <div id="login-btn">
        <button id="login" onclick=login()>WAX Login</button>
      </div>
      <div id="login-info" class="hidden">
        <span>Account : </span>
        <span id="account-name" style="min-width: 50px;display: inline-block;font-weight: bold;"></span>
        <span class="disconectIcon" style="color: red;" onclick=disconect()>&#10008;</span>
      </div>
      <span class="spliter"></span>
      <label>Total Gain/Lost : </label>
      <span id="totalGain"></span>
      <span id="totalGainCharm"></span>
      
      <!--
      <span class="spliter"></span>
      <span>Current Fuel : </span>
      <span id="current-boost" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakgas" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakoil" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakpow" style="min-width: 50px;display: inline-block;">NaN</span>
      <span id="current-snakven" style="min-width: 50px;display: inline-block;">NaN</span>
      <span class="spliter"></span>
      <span>Unclaimed fuel : </span>
      <span id="unclaimed-fuel" style="min-width: 50px;display: inline-block;">NaN</span>
      <span class="spliter"></span>
      <span>Other Token : </span>
      -->


    </div>
    <div>
      <div style="text-align: center;margin: 15px 0px;">
        <input id="user" name="user" type="text" placeholder="user name" style="color: black;"/>
        <input id="nbRace" name="nbRace" type="number" placeholder="10" style="color: black;width: 80px;"/>
        <button id="fetch_user" onclick="fetchData()">Fetch user data</button>
      </div>
      <table class="table" id="resultDisplay">
        <thead>
          <tr>
            <th scope="col" >Date</th>
            <th scope="col" >Cars</th>
            <th scope="col" >Driver</th>
            <th scope="col" >Copilote</th>
            <th scope="col" >League</th>
            <th scope="col" >Gear</th>
            <th scope="col" >Position</th>
            <th scope="col" >Reward</th>
            <th scope="col" data-bs-toggle="tooltip" data-bs-placement="right" title="This price is determined with the current price of token" >Gain/lost</th>
          </tr>  
        </thead>
      </table>  
      <div id="loader" class="hidden">
        <img src="./assets/medias/step-loader.gif" alt="loader">
        <br>
        <span id="loaderCount"></span>
      </div>
    </div>
  </div>

</body>
<script type="text/javascript" src="./assets/js/utils.js"></script>
<script type="text/javascript" src='./assets/js/scriptDashboard.js'></script>
<script type="module" src=" /node/script-table"></script>

<script>
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(element){
        return new bootstrap.Tooltip(element);
    });
</script>

<script type="text/javascript">
  var arr = {}; 
  var myRaces = []
  var user = "";

  var raceCost = {
    rookie : {
      fuel : "oilPrice",
      oil : [1800,10800,54000,270000]
    },
    intermediate : {
      fuel : "gasPrice",
      oil : [600,3600,18000,90000]
    },
    veteran : {
      fuel : "powPrice",
      oil : [200,1200,6000,30000]
    },
    master : {
      fuel : "venPrice",
      oil : [200,1200,6000,30000]
    }
  };

  $(document).ready(() => {
    getTokensPrices()


    if(checkLogin() == true){
      $("#user")[0].placeholder = sessionStorage.getItem("userAccount")
    }
  });

  async function fetchData(){
    if(!checkLogin()){
      return;
    }
    resetTable()

    $("#loader")[0].classList.remove("hidden");

    user = ($('#user').val() != "")? $('#user').val() : sessionStorage.getItem('userAccount');

    await asyncCall().then(async (response)=>{
      await createMyRaces(response.data);
    });
  }

  async function asyncCall(){    
    var nbRaces = ($('#nbRace').val() != "")? $('#nbRace').val() : 10;
    

    try {
        result = await $.ajax({
          url: '/getRaceList/'+user+'/'+nbRaces
        });

        return result;
    } catch (error) {
        console.error(error);
    }
  }
  async function getTokensPrices(){
    var tokens = 
    [
      {name : "charmPrice", id : "634"},
      {name : "boostPrice", id : "110"},
      {name : "oilPrice", id : "100"},
      {name : "gasPrice", id : "141"},
      {name : "powPrice", id : "152"},
      {name : "venPrice", id : "153"}
    ];

    tokens.forEach(async token  => {
      var tempPrice = await getTokenPrice(token.id);
      $("#"+token.name).html(tempPrice.last_price)
    })
  }

  async function getTokenPrice(token_id){    
   

    try {
        result = await $.ajax({
          url: 'https://wax.alcor.exchange/api/markets/'+token_id
        });
        return result;
    } catch (error) {
        console.error(error);
    }
  }

  async function createMyRaces(array){    
    return new Promise(async resolve => {
      raceArray = [];

      for(i=0;i<array.length; i++){
        $("#loaderCount").html(i+"/"+array.length)

        var tmpRace = {id : "",date : "",vehicle : {},driver : {},copilote : {},league : "",gear : "",position : "",reward : "",gainLost : {}};

        tmpRace.id =  array[i].id;

        tmpRace.date =  new Date(array[i].startedDate).toLocaleString();

        var vehicle = await later(array[i].vehicleAssetId);
        tmpRace.vehicle = vehicle;
        var driver = await later(array[i].driver1AssetId);
        tmpRace.driver = driver;
        var copilote = await later(array[i].driver2AssetId);
        tmpRace.copilote = copilote;

        tmpRace.league = array[i].league;
        tmpRace.gear = array[i].gearId;
        tmpRace.position =  array[i].position;

        var racesDetail = await getRaceDetail(array[i].race_id)
       
        //tmpRace.reward = reward;
        tmpRace.reward = racesDetail;
        raceArray.push(tmpRace);

      }
      await sortDisplayRaceArray(raceArray)

      resolve('resolved');
    });
  }
  async function getRewardList(prizesListe){
    return new Promise(async resolve => {
      var reward = {};

      
      prizesListe.forEach(async prize=>{
        if(prize.type == "ASSET"){
          reward.asset_id = prize.templateId;

        }
        if(prize.type == "TOKEN"){
          reward.charm = prize.charmTokenAmount;
        }
      })

      resolve(reward);
    })

  }



  async function sortDisplayRaceArray(races){

    $("#loader")[0].classList.add("hidden");

    var globalGain = 0;
    var globalGainCharm = 0;
    for(i=0;i<races.length; i++){

    //races.forEach(async element => {

      var positionCSS = "";

      switch(races[i].position){
        case 1: positionCSS = "style='color:#f0d148;font-size:20px;'"; break;
        case 2: positionCSS = "style='color:#f3e8bf;font-size:20px;'"; break;
        case 3: positionCSS = "style='color:#d28f2b;font-size:20px;'"; break;
        default:break;
      }

      //get reward list
      reward = await getRewardList(races[i].reward.prizes);
      
      var rewardDisplay = "";
      if(reward.charm != null){
        globalGainCharm = globalGainCharm + reward.charm
        rewardDisplay += "<img alt='Charm' src='https://play.novarally.io/assets/pic/CHARM.webp' width='26' height='26'><span>"+reward.charm+"</span>";

      }
      if(reward.asset_id != undefined){

        await getTemplateInfo("novarallywax",reward.asset_id).then(prize_template=>{
          reward.asset_img = prize_template.immutable_data.img;
        });

        rewardDisplay += "<a href='https://wax.atomichub.io/explorer/template/novarallywax/"+reward.asset_id+"' target='_blank'><img src='https://atomichub-ipfs.com/ipfs/"+reward.asset_img+"' style='width: 70px;' /></a>" 
      }



      var date = $("<td></td>").html("<span>"+races[i].date+"</span>") ;        
      var vehicleHtml = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+races[i].vehicle.template.immutable_data.img+"' style='width: 50px;' /><br><span>"+races[i].vehicle.name+"</span>") ;
      var driverHtml = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+races[i].driver.template.immutable_data.img+"' style='width: 50px;'/><br><span>"+races[i].driver.name+"</span>") ;
      var copiloteHtml = $("<td></td>").html("<img src='https://atomichub-ipfs.com/ipfs/"+races[i].copilote.template.immutable_data.img+"' style='width: 50px;'/><br><span>"+races[i].copilote.name+"</span>") ;
      var leagueHtml = $("<td></td>").html("<span>"+races[i].league+"</span>") ;
      var gearHtml = $("<td></td>").html("<span>"+races[i].gear+"</span>") ;
      var positionHtml = $("<td></td>").html("<span "+positionCSS+" >"+races[i].position+"</span>") ;

      var rewardHtml = $("<td></td>").html("<div>"+rewardDisplay+"</div>") ;

      var cost = "0";

      if(races[i].gear != "0"){
        var fuelPrice = $("#"+raceCost[races[i].league].fuel).html()

        var fuelAmount = raceCost[races[i].league].oil[(races[i].gear-1)]

        cost = fuelPrice * fuelAmount

      }

      var gainlost = (reward.charm *  $("#charmPrice").html()) - cost
      var gainLostHtml = $("<td></td>").html("<span>"+gainlost.toFixed(4)+" Wax</span>") ;        
      
      globalGain = globalGain + gainlost 

      var row = $("<tr class='raceRow'></tr>").append(date,vehicleHtml,driverHtml,copiloteHtml,leagueHtml,gearHtml,positionHtml,rewardHtml,gainLostHtml);   
      $("#resultDisplay").append(row);
      $("#totalGain").html(globalGain.toFixed(3)+" Wax");
      $("#totalGainCharm").html(globalGainCharm.toFixed(3)+" Charm");

    };

  }

  async function getRaceDetail(id_race){
    return new Promise(async resolve => {

      var temp = await $.ajax({
        url: '/getRaceDetail/'+id_race
      });

      temp.participants.forEach(participant=>{
        if(participant.accountName == user){
          resolve(participant);
        }
      })      
    })
  }
</script>
</html>