<html>
<head>
  <title>Dungeon Master Helper - Dashboard</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="./assets/css/style.css">
  <script src='./assets/js/waxjs.js'></script>
</head>


<body>
  <div id="root">

    <div style="margin-bottom: 150px;">
      <div style="text-align: center;margin: 15px 0px;">
        <input id="user" name="user" type="text" placeholder="user name" style="color: black;"/>
        <!--<input id="nbRace" name="nbRace" type="number" placeholder="10" style="color: black;width: 80px;"/>-->
        <button id="fetch_user" onclick="fetchData()">Fetch user data</button>
      </div>
      <table id="myTable">
        <thead>
          <tr>
            <th>Assets ID</th>
            <th>Sugested price</th>
            <th>Mining power</th>
            <th>Wax / MP</th>
          </tr>
        </thead>
        <tbody>
          <!-- Ajoutez vos lignes de tableau ici -->
        </tbody>
      </table>
    </div>
  </div>
  <footer>
    <div >Created By <a href="https://wax.bloks.io/account/unrsi.wam" target="_blank">FreeQyMat#4039</a> | <a href="https://github.com/Mathieuthiolat/NovaScriptLight" target="_blank">Github project </a> </div>
  </footer>
</body>
<script type="text/javascript" src="./assets/js/utils.js"></script>

<script>

  var myAssets = [];
  var stackabledTemplate;

  $(document).ready(function() {
    getStackabledTemplate()
  })

    async function fetchData(){
      user = $('#user').val();
      var json = await DmAssets(user)


      for (const line of json.rows) {
        var tmpLine = {assets_id : {},template_id : {},collection : {},price : {},mining_power : {},ratio : {}};

        //Get template id + collection name from them
        tmpLine.assets_id = line.asset_id;
        var detail = await detailAssets(line.asset_id)

        tmpLine.collection = detail.data.collection.collection_name
        tmpLine.template_id = detail.data.template.template_id

        var jsonInfo = await searchAssetsInfo(tmpLine.template_id)
        tmpLine.mining_power = jsonInfo['Mining power']

        var priceTmp = await ajaxPrice(tmpLine.template_id, tmpLine.collection);
        var mulipli = 1;
        if(priceTmp.data[0] != undefined){
          for(i = 0;i<priceTmp.data[0].price.token_precision;i++){
            mulipli=mulipli*10;
          }
          tmpLine.price = result.data[0].price.amount/mulipli

        }else{
          tmpLine.price = 0
        }


        tmpLine.ratio = tmpLine.price/tmpLine.mining_power;

        console.log("id : "+tmpLine.template_id+"| Price: "+tmpLine.price +"| Ratio: "+tmpLine.ratio)

        myAssets.push(tmpLine)

        setTimeout(() => {}, 500);
      }

      // Trier les données par ordre croissant de la puissance minière
      myAssets.sort(function(a, b) {
       return a.ratio - b.ratio;
      });

      var items = [];

      $.each(myAssets, function(key, val) {
       if(val.waxPrice == undefined || isNaN(val.waxPrice))
         return true;

       var link = "https://wax.atomichub.io/explorer/asset/"+val.assets_id
       items.push("<tr>");
       items.push("<td><a href='" + link + "' target='_blank'>" + val.assets_id  + "</a></td>");
       items.push("<td>" + val.price + "</td>");
       items.push("<td>" + val.mining_power + "</td>");
       items.push("<td>" + val.ratio + "</td>");
       items.push("</tr>");
      });
      $("#myTable tbody").html(items.join(""));
    }

  function getStackabledTemplate(){
    $.getJSON("./assets/dm_template_S9.json", function(data) {
      stackabledTemplate = data;
    });
  }

  async function searchAssetsInfo(templateID){
    var assetsDetail;

    $.each(stackabledTemplate, async function(i, v) {
      if (v["Template ID"] == templateID) {
        assetsDetail = v;
        return;
      }
    });

    return assetsDetail;
  }
  async function DmAssets(user){
    let assets;
    try {
      assets = await $.ajax({
        url: 'getDMAssets/'+user
      })
      return assets;
    } catch (error) {
      console.error(error);
    }
  }

  async function detailAssets(id_assets){
    let assets;
    try {
      assets = await $.ajax({
        url: '/getAssetsDetail/'+id_assets
      })
      return assets;
    } catch (error) {
      console.error(error);
    }
  }

  async function ajaxPrice(id,collection){
    try {
      result = await $.ajax({
        //url: 'https://atomic.wax.eosrio.io/atomicmarket/v1/prices/templates?template_id='+id
        url: 'https://atomic.wax.eosrio.io/atomicmarket/v1/sales?limit=10&order=asc&sort=price&state=1&template_id='+id+'&collection_name='+collection
      });
      return result;
    } catch (error) {
      console.error(error);
    }
  }

</script>
</html>